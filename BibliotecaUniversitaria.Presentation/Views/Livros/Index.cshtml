@model IEnumerable<BibliotecaUniversitaria.Application.ViewModels.LivroListViewModel>

@{
    ViewData["Title"] = "Livros";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-book"></i> @ViewData["Title"]</h2>
    <a asp-action="Create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Novo Livro
    </a>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="d-flex">
            <input id="searchInput" class="form-control me-2" type="search" placeholder="Buscar por título..." autocomplete="off">
            <button id="searchButton" class="btn btn-outline-primary" type="button">
                <i class="fas fa-search"></i> Buscar
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <a asp-action="Disponiveis" class="btn btn-success">
            <i class="fas fa-check-circle"></i> Ver Disponíveis
        </a>
        <button id="btnTodos" class="btn btn-secondary" type="button">
            <i class="fas fa-list"></i> Todos
        </button>
    </div>
</div>

<div id="loadingIndicator" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<div id="livrosContainer">
    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Título</th>
                        <th>Autor</th>
                        <th>Categoria</th>
                        <th>Disponível</th>
                        <th>Total</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="livrosTableBody">
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <strong>@item.Titulo</strong>
                            </td>
                            <td>@item.AutorNome</td>
                            <td>@item.CategoriaNome</td>
                            <td>
                                <span class="badge @(item.EstaDisponivel ? "bg-success" : "bg-danger")">
                                    @item.QuantidadeDisponivel
                                </span>
                            </td>
                            <td>@item.QuantidadeTotal</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info" title="Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>Nenhum livro encontrado</h4>
            <p>Não há livros cadastrados no sistema.</p>
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Cadastrar Primeiro Livro
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const searchInput = $('#searchInput');
            const searchButton = $('#searchButton');
            const btnTodos = $('#btnTodos');
            const livrosTableBody = $('#livrosTableBody');
            const livrosContainer = $('#livrosContainer');
            const loadingIndicator = $('#loadingIndicator');

            function performSearch(termo) {
                loadingIndicator.show();
                livrosContainer.hide();

                $.ajax({
                    url: '@Url.Action("SearchAjax", "Livros")',
                    type: 'GET',
                    data: { termo: termo },
                    success: function (data) {
                        loadingIndicator.hide();
                        livrosContainer.show();

                        if (data && data.length > 0) {
                            let html = '<div class="table-responsive">' +
                                '<table class="table table-striped table-hover">' +
                                '<thead class="table-dark">' +
                                '<tr>' +
                                '<th>Título</th>' +
                                '<th>Autor</th>' +
                                '<th>Categoria</th>' +
                                '<th>Disponível</th>' +
                                '<th>Total</th>' +
                                '<th class="text-center">Ações</th>' +
                                '</tr>' +
                                '</thead>' +
                                '<tbody>';

                            data.forEach(function (item) {
                                const disponivelClass = item.EstaDisponivel ? 'bg-success' : 'bg-danger';
                                html += '<tr>' +
                                    '<td><strong>' + item.Titulo + '</strong></td>' +
                                    '<td>' + item.AutorNome + '</td>' +
                                    '<td>' + item.CategoriaNome + '</td>' +
                                    '<td><span class="badge ' + disponivelClass + '">' + item.QuantidadeDisponivel + '</span></td>' +
                                    '<td>' + item.QuantidadeTotal + '</td>' +
                                    '<td class="text-center">' +
                                    '<div class="btn-group" role="group">' +
                                    '<a href="/Livros/Details/' + item.Id + '" class="btn btn-sm btn-info" title="Detalhes">' +
                                    '<i class="fas fa-eye"></i>' +
                                    '</a>' +
                                    '<a href="/Livros/Edit/' + item.Id + '" class="btn btn-sm btn-warning" title="Editar">' +
                                    '<i class="fas fa-edit"></i>' +
                                    '</a>' +
                                    '<a href="/Livros/Delete/' + item.Id + '" class="btn btn-sm btn-danger" title="Excluir">' +
                                    '<i class="fas fa-trash"></i>' +
                                    '</a>' +
                                    '</div>' +
                                    '</td>' +
                                    '</tr>';
                            });

                            html += '</tbody></table></div>';
                            livrosContainer.html(html);
                        } else {
                            livrosContainer.html(
                                '<div class="alert alert-info text-center">' +
                                '<i class="fas fa-info-circle fa-2x mb-3"></i>' +
                                '<h4>Nenhum livro encontrado</h4>' +
                                '<p>Não foram encontrados livros com o termo pesquisado.</p>' +
                                '<a href="/Livros/Create" class="btn btn-primary">' +
                                '<i class="fas fa-plus"></i> Cadastrar Novo Livro' +
                                '</a>' +
                                '</div>'
                            );
                        }
                    },
                    error: function () {
                        loadingIndicator.hide();
                        livrosContainer.show();
                        livrosContainer.html(
                            '<div class="alert alert-danger text-center">' +
                            '<i class="fas fa-exclamation-triangle fa-2x mb-3"></i>' +
                            '<h4>Erro ao buscar livros</h4>' +
                            '<p>Ocorreu um erro ao realizar a busca. Tente novamente.</p>' +
                            '</div>'
                        );
                    }
                });
            }

            searchButton.on('click', function () {
                const termo = searchInput.val();
                performSearch(termo);
            });

            btnTodos.on('click', function () {
                searchInput.val('');
                performSearch('');
            });

            searchInput.on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    searchButton.click();
                }
            });
        });
    </script>
}
